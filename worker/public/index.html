<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        .xterm {
            font-size: 14px !important;
        }

        /* 使用小视口高度单位解决移动端问题 */
        .h-svh {
            height: 100svh;
        }

        .terminal-container {
            height: calc(100svh - 130px); /* 减去顶部和底部固定元素的高度 */
        }
    </style>
</head>
<body class="m-0 p-0 bg-black font-mono h-svh flex flex-col">
    <div id="app" class="h-svh flex flex-col">
        <!-- 状态栏 - 固定顶部 -->
        <div class="px-5 py-2.5 bg-gray-800 text-green-400 shrink-0 fixed top-0 left-0 right-0 z-10" :class="{ 'text-red-500': isOffline }">
            {{ statusText }}
        </div>

        <!-- 终端容器 - 中间可滚动区域 -->
        <div id="terminal-container" class="terminal-container bg-black p-3 fixed top-16 left-0 right-0" :class="{ 'bottom-32': showShortcuts, 'bottom-16': !showShortcuts }"></div>

        <!-- 输入框 - 固定底部（快捷指令上方） -->
        <div v-if="showActions" class="p-3 bg-gray-800 shrink-0 fixed left-0 right-0 z-10 border-t border-gray-600" :class="{ 'bottom-20': showShortcuts, 'bottom-0': !showShortcuts }">
            <div class="flex gap-2">
                <button @click="sendSpace" class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-white text-sm border border-gray-500 rounded" title="Send Space">
                    ↓
                </button>
                <input
                    v-model="inputText"
                    @keydown.enter="sendInput"
                    placeholder="Type command here..."
                    class="flex-1 px-3 py-1 bg-gray-700 text-white text-sm border border-gray-600 rounded focus:outline-none focus:border-gray-400"
                />
                <button @click="sendInput" class="px-4 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm border border-blue-500 rounded">
                    Send
                </button>
                <button @click="clearInput" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white text-sm border border-gray-500 rounded">
                    Clear
                </button>
                <button @click="toggleShortcuts" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm border border-green-500 rounded">
                    {{ showShortcuts ? '▲' : '▼' }}
                </button>
            </div>
        </div>

        <!-- 快捷指令面板 - 最底部 -->
        <div v-if="showActions && showShortcuts" class="p-3 bg-gray-900 shrink-0 fixed bottom-0 left-0 right-0 z-10 flex flex-wrap gap-2 border-t border-gray-700">
            <button @click="sendEnter" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs border border-gray-600">
                Enter
            </button>
            <button @click="sendArrowUp" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs border border-gray-600">
                ↑ Up
            </button>
            <button @click="sendArrowDown" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs border border-gray-600">
                ↓ Down
            </button>
            <button @click="sendEsc" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs border border-gray-600">
                Esc
            </button>
            <button @click="sendCtrlC" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs border border-gray-600">
                Ctrl+C
            </button>
            <button @click="sendCtrlV" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs border border-gray-600">
                Ctrl+V
            </button>
            <button @click="restartPty" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs border border-gray-600">
                Restart
            </button>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const statusText = ref('连接中...');
                const isOffline = ref(false);
                const showActions = ref(false);
                const showShortcuts = ref(false);
                const inputText = ref('');
                
                let terminal = null;
                let fitAddon = null;
                let ws = null;
                let sessionId = null;

                const wsUrl = computed(() => 
                    sessionId ? `wss://${location.host}/ws?session=${sessionId}` : null
                );

                const initTerminal = () => {
                    terminal = new Terminal({
                        cursorBlink: true,
                        theme: {
                            background: '#000000',
                            foreground: '#ffffff',
                            cursor: '#ffffff'
                        },
                        fontSize: 14,
                        fontFamily: 'Courier New, monospace'
                    });

                    fitAddon = new FitAddon.FitAddon();
                    terminal.loadAddon(fitAddon);
                    terminal.open(document.getElementById('terminal-container'));
                    fitAddon.fit();

                    terminal.onData(function(data) {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'data.input',
                                to: 'desktop',
                                data: { input: data }
                            }));
                        }
                    });
                };

                const connect = () => {
                    if (!wsUrl.value) return;
                    
                    ws = new WebSocket(wsUrl.value);

                    ws.onopen = function() {
                        statusText.value = '已连接，等待桌面端...';
                        isOffline.value = false;
                        
                        ws.send(JSON.stringify({
                            type: 'connection.devices',
                            to: 'all',
                            data: { deviceType: 'web', status: 'connected' }
                        }));
                    };

                    ws.onmessage = function(event) {
                        try {
                            const message = JSON.parse(event.data);
                            
                            switch (message.type) {
                                case 'data.output':
                                    if (message.data && message.data.output) {
                                        terminal.write(message.data.output);
                                    }
                                    break;
                                    
                                case 'system.init':
                                    if (message.data && message.data.cols && message.data.rows) {
                                        terminal.resize(message.data.cols, message.data.rows);
                                        fitAddon.fit();
                                    }
                                    break;
                                    
                                case 'connection.devices':
                                    if (message.data && message.data.devices) {
                                        const desktopConnected = message.data.devices.desktop === 'connected';
                                        if (desktopConnected) {
                                            statusText.value = '已连接到桌面端';
                                            isOffline.value = false;
                                            showActions.value = true;
                                            
                                            // 桌面端连接后发送当前终端尺寸
                                            if (terminal) {
                                                ws.send(JSON.stringify({
                                                    type: 'system.resize',
                                                    to: 'desktop',
                                                    data: { cols: terminal.cols, rows: terminal.rows }
                                                }));
                                            }
                                        } else {
                                            statusText.value = '等待桌面端连接...';
                                            isOffline.value = true;
                                            showActions.value = false;
                                        }
                                    }
                                    break;
                            }
                        } catch (error) {
                            console.error('处理消息失败:', error);
                        }
                    };

                    ws.onclose = function() {
                        statusText.value = '连接已断开，3秒后重连...';
                        isOffline.value = true;
                        showActions.value = false;
                        setTimeout(connect, 3000);
                    };

                    ws.onerror = function(error) {
                        console.error('WebSocket错误:', error);
                        statusText.value = '连接错误';
                        isOffline.value = true;
                        showActions.value = false;
                    };
                };

                const restartPty = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'system.command',
                            to: 'desktop',
                            data: { command: 'restart' }
                        }));
                        statusText.value = '正在重启终端...';
                    }
                };


                const sendCtrlC = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'system.command',
                            to: 'desktop',
                            data: { command: 'ctrl_c' }
                        }));
                    }
                };

                const sendEnter = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'data.input',
                            to: 'desktop',
                            data: { input: '\r' }
                        }));
                    }
                };

                const sendArrowUp = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'data.input',
                            to: 'desktop',
                            data: { input: '\x1b[A' }
                        }));
                    }
                };

                const sendArrowDown = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'data.input',
                            to: 'desktop',
                            data: { input: '\x1b[B' }
                        }));
                    }
                };

                const sendEsc = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'data.input',
                            to: 'desktop',
                            data: { input: '\x1b' }
                        }));
                    }
                };

                const sendCtrlV = async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        if (ws && ws.readyState === WebSocket.OPEN && text) {
                            ws.send(JSON.stringify({
                                type: 'data.input',
                                to: 'desktop',
                                data: { input: text }
                            }));
                        }
                    } catch (error) {
                        console.error('无法读取剪贴板:', error);
                        // 在不支持剪贴板API的情况下，发送Ctrl+V组合键
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'data.input',
                                to: 'desktop',
                                data: { input: '\x16' }
                            }));
                        }
                    }
                };

                const sendInput = () => {
                    if (ws && ws.readyState === WebSocket.OPEN && inputText.value.trim()) {
                        ws.send(JSON.stringify({
                            type: 'data.input',
                            to: 'desktop',
                            data: { input: inputText.value }
                        }));
                        inputText.value = '';
                    }
                };

                const clearInput = () => {
                    inputText.value = '';
                };

                const sendSpace = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'data.input',
                            to: 'desktop',
                            data: { input: ' ' }
                        }));
                    }
                };

                const toggleShortcuts = () => {
                    showShortcuts.value = !showShortcuts.value;
                };

                onMounted(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    sessionId = urlParams.get('session');
                    
                    if (!sessionId || sessionId === 'default') {
                        statusText.value = '无效的访问链接，请通过桌面应用程序生成的链接访问';
                        isOffline.value = true;
                        document.getElementById('terminal-container').style.display = 'none';
                        return;
                    }

                    initTerminal();
                    connect();

                    window.addEventListener('resize', () => {
                        fitAddon.fit();
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'system.resize',
                                to: 'desktop',
                                data: { cols: terminal.cols, rows: terminal.rows }
                            }));
                        }
                    });

                    window.addEventListener('beforeunload', () => {
                        if (ws) ws.close();
                    });
                });

                return {
                    statusText,
                    isOffline,
                    showActions,
                    showShortcuts,
                    inputText,
                    restartPty,
                    sendCtrlC,
                    sendCtrlV,
                    sendEnter,
                    sendArrowUp,
                    sendArrowDown,
                    sendEsc,
                    sendInput,
                    clearInput,
                    sendSpace,
                    toggleShortcuts
                };
            }
        }).mount('#app');
    </script>
</body>
</html>